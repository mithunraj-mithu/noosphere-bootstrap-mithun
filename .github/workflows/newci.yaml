name: CI Pipeline
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore:
      - 'kubernetes/deployment.yaml'
      - 'terraform/'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'kubernetes/deployment.yaml'
      - 'terraform/'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  Git-leak-scan:
    name: Gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  Test-code: # for example purpose.
    name: Unit Testing
    needs: [Git-leak-scan]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      - run: npm ci --only=production
      - run: npm test || echo "No tests found, would add tests in a real project"

  Grype-scan:
    name: SAST - Scan Dependencies with Grype
    needs: [Git-leak-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: anchore/scan-action@v7
        with:
          path: "."
          fail-build: false
          severity-cutoff: high

  Semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [Test-code, Grype-scan]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
       - uses: actions/checkout@v4
         with:
         fetch-depth: 0
       - uses: actions/setup-node@v4
         with:
         node-version: '18'
       - run: npm install --save-dev semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/npm
       - name: Run semantic-release
         id: release
         run: npx semantic-release --cwd ./app
    env:
      ${{ secrets.GITHUB_TOKEN }}
         
        


  build-scan-and-push:
    name: Build, Scan, and Push Docker Image
    runs-on: ubuntu-latest
    needs: [Semantic-release]
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
      IMAGE_TAG: ${{ needs.Semantic-release.outputs.nextRelease.version }} 
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN }}
      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
      - name: Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  update-k8s:
    name: Update Kubernetes Deployment
    runs-on: ubuntu-latest
    needs: [build-scan-and-push]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.TOKEN }}
      - run: |
          curl -L -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq
      - run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      - name: Update K8s deployment with new image tag
        env:
          IMAGE_TAG: ${{ needs.build-scan-and-push.outputs.IMAGE_TAG }}
          IMAGE_NAME: ${{ github.repository }}
          REGISTRY: ghcr.io
        run: |
          yq -i '(.images[] | select(.name == "ghcr.io/mithunraj-mithu/noosphere-bootstrap-mithun")).newTag = strenv(IMAGE_TAG)' k8s/overlays/dev/kustomization.yaml
      - run: |
          git add k8s/overlays/dev/kustomization.yaml
          git commit -m "Update K8s deployment to image ${{ needs.build-scan-and-push.outputs.IMAGE_TAG }} [skip ci]" || echo "No changes to commit"
          git push
